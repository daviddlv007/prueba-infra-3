name: 'Terraform CD'

on:
  push:
    branches: [main]
    paths:
      - 'infra/terraform/environments/dev/**'
      - 'infra/terraform/modules/**'
  workflow_dispatch:

env:
  TF_VERSION: 1.8.2
  AWS_REGION: us-east-1

jobs:
  terraform-deploy:
    name: 'Terraform Apply to Production'
    runs-on: ubuntu-latest
    environment: production
    permissions:
      id-token: write
      contents: read

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Setup environment variables
      run: |
        echo "PROJECT_NAME=$(basename $GITHUB_REPOSITORY)" >> $GITHUB_ENV
        echo "ENVIRONMENT=dev" >> $GITHUB_ENV

    - name: Setup Terraform Backend (if needed)
      run: |
        chmod +x ./infra/terraform/scripts/check-backend.sh
        chmod +x ./infra/terraform/scripts/setup-backend.sh
        export ENVIRONMENT=dev
        export PROJECT_NAME=${{ env.PROJECT_NAME }}
        if ! ./infra/terraform/scripts/check-backend.sh; then
          echo "Creating backend resources..."
          ./infra/terraform/scripts/setup-backend.sh
        fi

    - name: Terraform Init
      run: |
        echo "Initializing backend with dynamic configuration..."
        chmod +x ./infra/terraform/scripts/init-backend.sh
        ./infra/terraform/scripts/init-backend.sh
      working-directory: ./
      
    - name: Terraform Validate
      run: terraform validate
      working-directory: ./infra/terraform/environments/dev

    - name: Terraform Plan
      run: terraform plan -input=false -out=tfplan
      working-directory: ./infra/terraform/environments/dev
      env:
        TF_CLI_ARGS: "-var-file=terraform.tfvars"

    - name: Terraform Apply
      run: terraform apply -input=false -auto-approve tfplan
      working-directory: ./infra/terraform/environments/dev

    - name: Generate Infrastructure Documentation
      run: |
        terraform output -json > infrastructure.json
        ./infra/terraform/scripts/generate-docs.sh
      working-directory: ./infra/terraform/environments/dev

    - name: Update GitHub Environment Status
      run: |
        echo "Deployment completed successfully at $(date)" > deployment-status.md
        echo "Project: ${{ env.PROJECT_NAME }}" >> deployment-status.md
        echo "Environment: dev" >> deployment-status.md
      if: success()

    - name: Upload Deployment Report
      uses: actions/upload-artifact@v4
      with:
        name: deployment-report
        path: deployment-status.md
        if-no-files-found: ignore