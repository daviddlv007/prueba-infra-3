name: 'Terraform CD'

on:
  push:
    branches: [main]
    paths:
      - 'infra/terraform/environments/dev/**'
      - 'infra/terraform/modules/**'
  workflow_dispatch:

env:
  TF_VERSION: 1.13.1
  AWS_REGION: us-east-1

jobs:
  terraform-deploy:
    name: 'Terraform Apply to Production'
    runs-on: ubuntu-latest
    environment: production
    permissions:
      id-token: write
      contents: read

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Setup environment variables
      run: |
        echo "PROJECT_NAME=$(basename $GITHUB_REPOSITORY)" >> $GITHUB_ENV
        echo "ENVIRONMENT=dev" >> $GITHUB_ENV

    - name: Setup Terraform Backend (if needed)
      run: |
        echo "Setting up backend resources if needed..."
        chmod +x ./infra/terraform/scripts/check-backend.sh
        chmod +x ./infra/terraform/scripts/setup-backend.sh
        
        # Usar valores directamente
        ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
        if ! ./infra/terraform/scripts/check-backend.sh; then
          echo "Creating backend resources..."
          ./infra/terraform/scripts/setup-backend.sh
        else
          echo "Backend resources already exist"
        fi
      working-directory: ./

    - name: Terraform Init
      run: |
        echo "Initializing Terraform with dynamic backend..."
        cd ./infra/terraform/environments/dev
        
        # Obtener valores dinámicamente
        ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
        PROJECT_NAME=$(basename $(git rev-parse --show-toplevel))
        ENVIRONMENT="dev"
        
        echo "Initializing for:"
        echo "Project: $PROJECT_NAME"
        echo "Account: $ACCOUNT_ID"
        echo "Environment: $ENVIRONMENT"
        
        # Inicializar Terraform completamente
        terraform init -reconfigure -input=false \
          -backend-config="bucket=terraform-state-${ACCOUNT_ID}-${ENVIRONMENT}" \
          -backend-config="key=${PROJECT_NAME}/${ENVIRONMENT}/terraform.tfstate" \
          -backend-config="dynamodb_table=terraform-locks-${ACCOUNT_ID}" \
          -backend-config="region=us-east-1" \
          -backend-config="encrypt=true"
        
        # Forzar instalación de módulos y providers
        terraform get -update
        
        echo "✅ Terraform initialization completed successfully!"
        ls -la .terraform/
      working-directory: ./

    - name: Terraform Validate
      run: terraform validate
      working-directory: ./infra/terraform/environments/dev

    - name: Terraform Plan
      run: terraform plan -input=false -out=tfplan
      working-directory: ./infra/terraform/environments/dev
      env:
        TF_CLI_ARGS: "-var-file=terraform.tfvars"

    - name: Terraform Apply
      run: terraform apply -input=false -auto-approve tfplan
      working-directory: ./infra/terraform/environments/dev

    - name: Generate Infrastructure Documentation
      run: |
        terraform output -json > infrastructure.json
        ./infra/terraform/scripts/generate-docs.sh
      working-directory: ./infra/terraform/environments/dev

    - name: Update GitHub Environment Status
      run: |
        echo "Deployment completed successfully at $(date)" > deployment-status.md
        echo "Project: ${{ env.PROJECT_NAME }}" >> deployment-status.md
        echo "Environment: dev" >> deployment-status.md
      if: success()

    - name: Upload Deployment Report
      uses: actions/upload-artifact@v4
      with:
        name: deployment-report
        path: deployment-status.md