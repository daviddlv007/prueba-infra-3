name: Bootstrap EC2 - Preparar instancia

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  setup-ec2:
    runs-on: ubuntu-latest
    steps:
      - name: Preparar EC2
        uses: appleboy/ssh-action@v0.1.9
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -euo pipefail

            echo "=== Actualizando sistema ==="
            sudo dnf -y update

            echo "=== Instalando Git ==="
            sudo dnf -y install git

            echo "=== Instalando Docker ==="
            sudo dnf -y install docker
            sudo systemctl enable docker
            sudo systemctl start docker

            echo "=== Agregando usuario al grupo docker ==="
            sudo usermod -aG docker $USER
            # newgrp docker no es confiable en scripts no interactivos

            echo "=== Instalando Docker Compose v2 ==="
            DOCKER_COMPOSE_VERSION="v2.20.2"
            sudo mkdir -p /usr/local/lib/docker/cli-plugins
            sudo curl -L "https://github.com/docker/compose/releases/download/${DOCKER_COMPOSE_VERSION}/docker-compose-linux-x86_64" -o /usr/local/lib/docker/cli-plugins/docker-compose
            sudo chmod +x /usr/local/lib/docker/cli-plugins/docker-compose

            echo "=== Verificando instalaciones ==="
            git --version
            docker --version
            docker compose version  # Docker Compose v2 usa espacio, no guion medio

            echo "=== Bootstrap completo ==="
