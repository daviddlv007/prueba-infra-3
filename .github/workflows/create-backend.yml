name: Crear Backend S3 y DynamoDB

on:
  workflow_dispatch:
    inputs:
      project_name:
        description: 'Nombre del proyecto'
        required: false
      aws_region:
        description: 'Región AWS'
        required: false
      bucket_name:
        description: 'Bucket S3 (opcional, generado automáticamente si vacío)'
        required: false
      table_name:
        description: 'Tabla DynamoDB (opcional, generada automáticamente si vacía)'
        required: false

permissions:
  contents: read

jobs:
  create-backend:
    runs-on: ubuntu-latest
    steps:
      - name: Configurar credenciales AWS
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: ${{ github.event.inputs.aws_region || 'us-east-1' }}

      - name: Crear bucket S3 y tabla DynamoDB
        run: |
          set -euo pipefail
          PROJECT="${{ github.event.inputs.project_name || 'prueba-infra-3' }}"
          REGION="${{ github.event.inputs.aws_region || 'us-east-1' }}"
          BUCKET="${{ github.event.inputs.bucket_name || '' }}"
          TABLE="${{ github.event.inputs.table_name || 'terraform-state-lock' }}"

          # Si no se pasó bucket_name, se construye en Bash
          if [ -z "$BUCKET" ]; then
            BUCKET="${PROJECT}-${GITHUB_REPOSITORY}-backend"
          fi

          echo "Verificando bucket S3..."
          if aws s3api head-bucket --bucket "$BUCKET" 2>/dev/null; then
            echo "Bucket ya existe: $BUCKET"
          else
            echo "Creando bucket S3: $BUCKET"
            if [ "$REGION" = "us-east-1" ]; then
              aws s3api create-bucket --bucket "$BUCKET" --region "$REGION"
            else
              aws s3api create-bucket --bucket "$BUCKET" --region "$REGION" --create-bucket-configuration LocationConstraint=$REGION
            fi
            aws s3api put-bucket-encryption --bucket "$BUCKET" --server-side-encryption-configuration '{"Rules":[{"ApplyServerSideEncryptionByDefault":{"SSEAlgorithm":"AES256"}}]}'
            aws s3api put-bucket-versioning --bucket "$BUCKET" --versioning-configuration Status=Enabled
            aws s3api put-public-access-block --bucket "$BUCKET" --public-access-block-configuration BlockPublicAcls=true,IgnorePublicAcls=true,BlockPublicPolicy=true,RestrictPublicBuckets=true
            echo "Bucket creado y endurecido"
          fi

          echo "Verificando tabla DynamoDB..."
          if aws dynamodb describe-table --table-name "$TABLE" >/dev/null 2>&1; then
            echo "Tabla DynamoDB ya existe: $TABLE"
          else
            echo "Creando tabla DynamoDB: $TABLE"
            aws dynamodb create-table \
              --table-name "$TABLE" \
              --attribute-definitions AttributeName=LockID,AttributeType=S \
              --key-schema AttributeName=LockID,KeyType=HASH \
              --provisioned-throughput ReadCapacityUnits=5,WriteCapacityUnits=5 \
              --region "$REGION"
            echo "Tabla DynamoDB creada"
          fi

          echo "Backend listo."

